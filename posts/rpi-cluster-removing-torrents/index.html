<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Removing Old Torrents Using a Raspberry Pi Cluster | #!/matt/rathbun</title>
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3/build/web/hack.css">

      <link rel="stylesheet" href="/css/colors.min.73a4fa8b5660037be8ad75523eebd8a911e1d976ef5865a3e6d301d6dce76d85.css" integrity="sha256-c6T6i1ZgA3vorXVSPuvYqRHh2XbvWGWj5tMB1tznbYU=" crossorigin="anonymous">
      <link rel="stylesheet" href="/css/main.min.3f68ed0ec8a35a8e6451d05944a3de0245be53651949cf19030f6db7f6d71788.css" integrity="sha256-P2jtDsijWo5kUdBZRKPeAkW&#43;U2UZSc8ZAw9tt/bXF4g=" crossorigin="anonymous">
      <link rel="stylesheet" href="/css/syntax.min.b840b9ed282a8d467cd5fb90af17571bda7b0cdcca46af05b6f2e9ac8b0377f9.css" integrity="sha256-uEC57SgqjUZ81fuQrxdXG9p7DNzKRq8FtvLprIsDd/k=" crossorigin="anonymous">


</head>
<body>
  <header>
    <div class="nav">
  <a href="/" class="accent">#!/matt/rathbun</a>
  <a href="/posts" class="left">/posts</a>

  <a href="https://github.com/mattbun" class="right">github</a>
</div>

  </header>
  <main>
    
  <h1>Removing Old Torrents Using a Raspberry Pi Cluster</h1>

  
  
  <time datetime="2021-02-23T00:00:00&#43;00:00">February 23, 2021</time>
  |
  
    <a class="tag" href="/tags/raspberrypi/">#raspberrypi</a>
    <a class="tag" href="/tags/kubernetes/">#kubernetes</a>
    <a class="tag" href="/tags/nodejs/">#nodejs</a>
    <a class="tag" href="/tags/containers/">#containers</a>


  <br>
  <br>
  <p>My new Raspberry Pi cluster is a little unstable and pretty limited since the nodes have just 1GB of memory. What the heck could I possibly use this for?</p>
<p>Turns out it&rsquo;s great at running simple cron jobs. In this case, one that cleans up old torrents on a remote qbittorrent server.</p>
<h1 id="the-problem">The Problem</h1>
<p>I download a lot of uhh&hellip; <em>linux distributions</em> using qbittorrent. One thing that&rsquo;s always bugged me about it is that it doesn&rsquo;t automatically remove old downloads. My home server is completely automated <em>except</em> it won&rsquo;t clean these up.</p>
<p>This isn&rsquo;t just a problem with qbittorrent, I&rsquo;ve wanted this on every bittorrent client I&rsquo;ve used. There <em>has</em> to be a way to do this.</p>
<h1 id="the-solution">The Solution</h1>
<p>qbittorrent has an API! It&rsquo;s kind of hard to find since their wiki seems to be world writable (<a href="https://github.com/qbittorrent/qBittorrent/wiki/Web-API-Documentation">?</a>) but <a href="https://github.com/qbittorrent/qBittorrent/wiki/Web-API-Documentation/87ec6b289ea5376b648e8cbb1373fb538da9f01d">eventually you&rsquo;ll find it</a>. There&rsquo;s even <a href="https://www.npmjs.com/package/qbittorrent-api-v2">an npm package</a>, though I didn&rsquo;t have great luck with that.</p>
<p>Anyway, once I found the API documentation, I was able to put this together:</p>
<h2 id="introducing-qbittorrent-reaper">Introducing qbittorrent-reaper</h2>
<p><strong><a href="https://github.com/mattbun/qbittorrent-reaper">qbittorrent-reaper</a></strong> is a simple Node.js application, written in Typescript, that removes torrents older than a given age from qbittorrent.</p>
<p>You can find a docker image for it <a href="https://hub.docker.com/r/mattbun/qbittorrent-reaper">here</a>!</p>
<h3 id="how-do-you-run-it-on-a-schedule">How Do You Run It on a Schedule?</h3>
<p>qbittorrent-reaper won&rsquo;t run on a schedule on its own. It&rsquo;s meant to be run as a Kubernetes CronJob. I&rsquo;m planning on putting up a helm chart for it, but for now you could run the following with <code>kubectl apply</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CronJob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">qbittorrent-reaper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0 0 * * *&#34;</span><span class="w"> </span><span class="c"># daily at midnight</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">concurrencyPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Replace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">qbittorrent-reaper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">mattbun/qbittorrent-reaper:main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">QBITTORRENT_HOST</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.1</span><span class="l">.x</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">QBITTORRENT_PORT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">QBITTORRENT_USERNAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">totallyCoolUsername</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">QBITTORRENT_PASSWORD</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;this shouldn&#39;t be here&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">MAX_TORRENT_AGE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">2w</span><span class="w">
</span></span></span></code></pre></div><p>(you probably don&rsquo;t want the password exposed like that)</p>
<h3 id="does-it-run-on-arm-processors">Does It Run on ARM Processors?</h3>
<p>The <a href="https://www.docker.com/blog/docker-v2-github-action-is-now-ga/">new docker/build-push-action/v2 action</a> makes it super easy to build the image for multiple CPU architectures (including my cluster&rsquo;s <code>arm/v7</code> ðŸŽ‰). It&rsquo;s as easy as this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Set up QEMU</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/setup-qemu-action@v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Set up Docker Buildx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/setup-buildx-action@v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Login to DockerHub</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/login-action@v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">${{ secrets.DOCKERHUB_USERNAME }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">${{ secrets.DOCKERHUB_TOKEN }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Build and push</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/build-push-action@v2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l">./Dockerfile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">platforms</span><span class="p">:</span><span class="w"> </span><span class="l">linux/amd64,linux/arm/v7,linux/arm64</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">push</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      mattbun/qbittorrent-reaper:latest
</span></span></span><span class="line"><span class="cl"><span class="sd">      mattbun/qbittorrent-reaper:main
</span></span></span><span class="line"><span class="cl"><span class="sd">      mattbun/qbittorrent-reaper:${{ github.event.release.tag_name }}</span><span class="w">
</span></span></span></code></pre></div><h3 id="also-id-like-to-point-out">Also I&rsquo;d Like to Point Out&hellip;</h3>
<p>Versioning and releases are handled automatically by <a href="https://github.com/semantic-release/semantic-release">semantic-release</a> as long as I remember to stick to semantic commits. This means that the whole release process is automated! Whenever I push a commit to <code>main</code> that <code>semantic-release</code> deems worthy of a version bump, it creates a release in github and builds a new docker image.</p>
<p>I&rsquo;m <em>really</em> excited about this. I might just make a template out of it.</p>
<h1 id="back-to-the-cluster">Back to the cluster</h1>
<p>Turns out my slightly unstable cluster is perfect for running this:</p>
<p><img src="/posts/rpi-cluster-removing-torrents/kubectl_jobs.png" alt="Three successful jobs!"></p>
<p>This has been working great for the last few weeks now. Old torrents are getting removed and my cluster has that warm feeling of accomplishment. Win win.</p>

  </main>
  <footer>
    <p>Copyright 2025 Matt Rathbun. Made with <a href="https://gohugo.io/"> Hugo </a> and <a href="https://0x96f.dev/theme">0x96f</a>.</p>

  </footer>
</body>
</html>
