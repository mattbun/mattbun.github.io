<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Introducing Nappa and the Next Iteration of My k3s Cluster | #!/matt/rathbun</title>
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3/build/web/hack.css">

      <link rel="stylesheet" href="/css/colors.min.73a4fa8b5660037be8ad75523eebd8a911e1d976ef5865a3e6d301d6dce76d85.css" integrity="sha256-c6T6i1ZgA3vorXVSPuvYqRHh2XbvWGWj5tMB1tznbYU=" crossorigin="anonymous">
      <link rel="stylesheet" href="/css/main.min.8bcbf9eb26427c3105612f742f360675dc6cc547154518ba45f73a0523753be8.css" integrity="sha256-i8v56yZCfDEFYS90LzYGddxsxUcVRRi6Rfc6BSN1O&#43;g=" crossorigin="anonymous">
      <link rel="stylesheet" href="/css/syntax.min.b840b9ed282a8d467cd5fb90af17571bda7b0cdcca46af05b6f2e9ac8b0377f9.css" integrity="sha256-uEC57SgqjUZ81fuQrxdXG9p7DNzKRq8FtvLprIsDd/k=" crossorigin="anonymous">


</head>
<body>
  <header>
    <div class="nav">
  <a href="/" class="accent">#!/matt/rathbun</a>
  <a href="/posts" class="left">/posts</a>

  <a href="https://github.com/mattbun" class="right">github</a>
</div>

  </header>
  <main>
    
  <h1>Introducing Nappa and the Next Iteration of My k3s Cluster</h1>

  
  
  <time datetime="2022-12-05T00:00:00&#43;00:00">December 5, 2022</time>
  |
  
    <a class="tag" href="/tags/nappa/">#nappa</a>
    <a class="tag" href="/tags/nix/">#nix</a>
    <a class="tag" href="/tags/nixos/">#nixos</a>
    <a class="tag" href="/tags/k3s/">#k3s</a>
    <a class="tag" href="/tags/kubernetes/">#kubernetes</a>


  <br>
  <br>
  <p>It&rsquo;s been almost two years since I built my <a href="/posts/rpi-k3s-cluster">first Raspberry Pi-powered k3s cluster</a>. A lot&rsquo;s changed! There&rsquo;s a new node in the cluster and I&rsquo;ve gone off the deep end switching everything to NixOS. In this post, I&rsquo;ll talk about the new node and some of the nix options that enable it.</p>
<h1 id="nappa-the-control-plane">Nappa&hellip; the Control Plane?</h1>
<p>The new addition to the cluster is <code>nappa</code>, an x86 NUC that now runs the control plane. Its extra processing power fixes the stability issues I had when the cluster was all Raspberry Pis. It also serves as network gateway (it has two ethernet ports!) and NFS server (for persistent volume storage) for the rest of the cluster. The new diagram looks like this:</p>
<p><img src="/posts/nappa-intro/nappa-diagram.png" alt="nappa cluster network setup"></p>
<p>Ok and I also splurged on some new Raspberry Pis ðŸ’°. <code>saibaman1</code> and <code>saibaman2</code> are now Raspberry Pi 4s with 8GB of memory. More memory, more containers!</p>
<h1 id="setting-up-a-network-gateway-in-nixos">Setting up a Network Gateway in NixOS</h1>
<p><code>nappa</code> runs NixOS, which makes it really simple to set up <a href="https://thekelleys.org.uk/dnsmasq/doc.html">dnsmasq</a>. In the config below, I set up a subnet at 192.168.2.x, but only on the ethernet port connected to the Raspberry Pis:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="n">services</span><span class="o">.</span><span class="n">dnsmasq</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">extraConfig</span> <span class="o">=</span> <span class="s1">&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    interface=enp4s0
</span></span></span><span class="line"><span class="cl"><span class="s1">    dhcp-range=192.168.2.10,192.168.2.250,255.255.255.0,12h
</span></span></span><span class="line"><span class="cl"><span class="s1">  &#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>Next, I set up an iptables rule to allow the Raspberry Pis to reach out to the outside network. You can see it in the <code>networking.firewall.extraCommands</code> option below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="n">networking</span><span class="o">.</span><span class="n">firewall</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">extraCommands</span> <span class="o">=</span> <span class="s1">&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    iptables -t nat -A POSTROUTING -o eno1 -j MASQUERADE
</span></span></span><span class="line"><span class="cl"><span class="s1">  &#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">trustedInterfaces</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&#34;eno1&#34;</span> <span class="s2">&#34;enp4s0&#34;</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">allowedTCPPortRanges</span> <span class="o">=</span> <span class="p">[{</span> <span class="n">from</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">to</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span> <span class="p">}];</span>
</span></span><span class="line"><span class="cl">  <span class="n">allowedUDPPortRanges</span> <span class="o">=</span> <span class="p">[{</span> <span class="n">from</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">to</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span> <span class="p">}];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p><em>Wait</em>, am I enabling a firewall just to configure it to open all ports? Yep! Enabling the firewall is a requirement for iptables, but I&rsquo;m opening up all of the ports so it doesn&rsquo;t get in the way of anything I&rsquo;m working on.</p>
<h1 id="k3s-in-nixos">k3s in NixOS</h1>
<p>Enabling k3s is another simple NixOS config option:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="n">services</span><span class="o">.</span><span class="n">k3s</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">role</span> <span class="o">=</span> <span class="s2">&#34;server&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">extraFlags</span> <span class="o">=</span> <span class="s2">&#34;--advertise-address=192.168.2.1 --node-ip=192.168.2.1 --node-external-ip=192.168.1.4 --flannel-backend=host-gw --flannel-iface=enp4s0&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>Phew, that&rsquo;s a lot of <code>extraFlags</code>. They&rsquo;re all needed due to <code>nappa</code>&rsquo;s weird networking setup. Note that k3s has flannel built in. NixOS&rsquo;s <code>service.flannel</code> option won&rsquo;t do anything here. Speaking of which&hellip;</p>
<h2 id="flannel-f-ups">Flannel F***-ups</h2>
<p>After first setting up this cluster, everything seemed fine but there was some sort of networking issue. HTTP requests sent to services backed by pods running on Raspberry Pi nodes would time out, but they&rsquo;d be fine if the pods were running on <code>nappa</code>. I initially pointed the blame at the Raspberry Pis, poring through logs and configuration to try to figure out what was happening. But the problem was actually with <code>nappa</code>, which needed an additional flannel option passed to k3s:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">--flannel-iface<span class="o">=</span>enp4s0
</span></span></code></pre></div><p>That tells flannel to use the same ethernet port that the Raspberry Pis are connected to. All better!</p>
<h1 id="thats-it-for-now">That&rsquo;s it for now!</h1>
<p>The full configuration for <code>nappa</code> (and the rest of the cluster) can be found <a href="https://github.com/mattbun/nappa-cluster">here</a>. In my next post, I&rsquo;ll go through the changes I&rsquo;ve made to the Raspberry Pis. Spoiler alert: they&rsquo;re also on NixOS!</p>

  </main>
  <footer>
    <p>Copyright 2025 Matt Rathbun. Made with <a href="https://gohugo.io/"> Hugo </a> and <a href="https://0x96f.dev/theme">0x96f</a>.</p>

  </footer>
</body>
</html>
