<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Posts on #!/matt/rathbun</title>
    <link>/posts/</link>
    <description>Recent content in Posts on #!/matt/rathbun</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <copyright>&amp;copy; 2020 Matt Rathbun</copyright>
    <lastBuildDate>Mon, 05 Dec 2022 00:00:00 +0000</lastBuildDate><atom:link href="/posts/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Introducing Nappa and the Next Iteration of My k3s Cluster</title>
      <link>/posts/nappa-intro/</link>
      <pubDate>Mon, 05 Dec 2022 00:00:00 +0000</pubDate>
      
      <guid>/posts/nappa-intro/</guid>
      <description>&lt;p&gt;It&amp;rsquo;s been almost two years since I built my &lt;a href=&#34;/posts/rpi-k3s-cluster&#34;&gt;first Raspberry Pi-powered k3s cluster&lt;/a&gt;. A lot&amp;rsquo;s changed! There&amp;rsquo;s a new node in the cluster and I&amp;rsquo;ve gone off the deep end switching everything to NixOS. In this post, I&amp;rsquo;ll talk about the new node and some of the nix options that enable it.&lt;/p&gt;</description>
      <content>&lt;p&gt;It&amp;rsquo;s been almost two years since I built my &lt;a href=&#34;/posts/rpi-k3s-cluster&#34;&gt;first Raspberry Pi-powered k3s cluster&lt;/a&gt;. A lot&amp;rsquo;s changed! There&amp;rsquo;s a new node in the cluster and I&amp;rsquo;ve gone off the deep end switching everything to NixOS. In this post, I&amp;rsquo;ll talk about the new node and some of the nix options that enable it.&lt;/p&gt;
&lt;h1 id=&#34;nappa-the-control-plane&#34;&gt;Nappa&amp;hellip; the Control Plane?&lt;/h1&gt;
&lt;p&gt;The new addition to the cluster is &lt;code&gt;nappa&lt;/code&gt;, an x86 NUC that now runs the control plane. Its extra processing power fixes the stability issues I had when the cluster was all Raspberry Pis. It also serves as network gateway (it has two ethernet ports!) and NFS server (for persistent volume storage) for the rest of the cluster. The new diagram looks like this:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;nappa-diagram.png&#34; alt=&#34;nappa cluster network setup&#34;&gt;&lt;/p&gt;
&lt;p&gt;Ok and I also splurged on some new Raspberry Pis ðŸ’°. &lt;code&gt;saibaman1&lt;/code&gt; and &lt;code&gt;saibaman2&lt;/code&gt; are now Raspberry Pi 4s with 8GB of memory. More memory, more containers!&lt;/p&gt;
&lt;h1 id=&#34;setting-up-a-network-gateway-in-nixos&#34;&gt;Setting up a Network Gateway in NixOS&lt;/h1&gt;
&lt;p&gt;&lt;code&gt;nappa&lt;/code&gt; runs NixOS, which makes it really simple to set up &lt;a href=&#34;https://thekelleys.org.uk/dnsmasq/doc.html&#34;&gt;dnsmasq&lt;/a&gt;. In the config below, I set up a subnet at 192.168.2.x, but only on the ethernet port connected to the Raspberry Pis:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-nix&#34; data-lang=&#34;nix&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;services&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;dnsmasq &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;=&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  enable &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  extraConfig &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;&amp;#39;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    interface=enp4s0
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    dhcp-range=192.168.2.10,192.168.2.250,255.255.255.0,12h
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  &amp;#39;&amp;#39;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;};
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Next, I set up an iptables rule to allow the Raspberry Pis to reach out to the outside network. You can see it in the &lt;code&gt;networking.firewall.extraCommands&lt;/code&gt; option below:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-nix&#34; data-lang=&#34;nix&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;networking&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;firewall &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;=&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  enable &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  extraCommands &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;&amp;#39;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    iptables -t nat -A POSTROUTING -o eno1 -j MASQUERADE
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  &amp;#39;&amp;#39;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  trustedInterfaces &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [ &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;eno1&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;enp4s0&amp;#34;&lt;/span&gt; ];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  allowedTCPPortRanges &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [{ from &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;; to &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;65535&lt;/span&gt;; }];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  allowedUDPPortRanges &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [{ from &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;; to &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;65535&lt;/span&gt;; }];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;};
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;em&gt;Wait&lt;/em&gt;, am I enabling a firewall just to configure it to open all ports? Yep! Enabling the firewall is a requirement for iptables, but I&amp;rsquo;m opening up all of the ports so it doesn&amp;rsquo;t get in the way of anything I&amp;rsquo;m working on.&lt;/p&gt;
&lt;h1 id=&#34;k3s-in-nixos&#34;&gt;k3s in NixOS&lt;/h1&gt;
&lt;p&gt;Enabling k3s is another simple NixOS config option:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-nix&#34; data-lang=&#34;nix&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;services&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;k3s &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;=&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  enable &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  role &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;server&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  extraFlags &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;--advertise-address=192.168.2.1 --node-ip=192.168.2.1 --node-external-ip=192.168.1.4 --flannel-backend=host-gw --flannel-iface=enp4s0&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;};
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Phew, that&amp;rsquo;s a lot of &lt;code&gt;extraFlags&lt;/code&gt;. They&amp;rsquo;re all needed due to &lt;code&gt;nappa&lt;/code&gt;&amp;rsquo;s weird networking setup. Note that k3s has flannel built in. NixOS&amp;rsquo;s &lt;code&gt;service.flannel&lt;/code&gt; option won&amp;rsquo;t do anything here. Speaking of which&amp;hellip;&lt;/p&gt;
&lt;h2 id=&#34;flannel-f-ups&#34;&gt;Flannel F***-ups&lt;/h2&gt;
&lt;p&gt;After first setting up this cluster, everything seemed fine but there was some sort of networking issue. HTTP requests sent to services backed by pods running on Raspberry Pi nodes would time out, but they&amp;rsquo;d be fine if the pods were running on &lt;code&gt;nappa&lt;/code&gt;. I initially pointed the blame at the Raspberry Pis, poring through logs and configuration to try to figure out what was happening. But the problem was actually with &lt;code&gt;nappa&lt;/code&gt;, which needed an additional flannel option passed to k3s:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;--flannel-iface&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;enp4s0
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;That tells flannel to use the same ethernet port that the Raspberry Pis are connected to. All better!&lt;/p&gt;
&lt;h1 id=&#34;thats-it-for-now&#34;&gt;That&amp;rsquo;s it for now!&lt;/h1&gt;
&lt;p&gt;The full configuration for &lt;code&gt;nappa&lt;/code&gt; (and the rest of the cluster) can be found &lt;a href=&#34;https://github.com/mattbun/nappa&#34;&gt;here&lt;/a&gt;. In my next post, I&amp;rsquo;ll go through the changes I&amp;rsquo;ve made to the Raspberry Pis. Spoiler alert: they&amp;rsquo;re also on NixOS!&lt;/p&gt;</content>
    </item>
    
    <item>
      <title>Installing Nix and Home Manager in Arch Linux</title>
      <link>/posts/nix-arch/</link>
      <pubDate>Tue, 04 Oct 2022 00:00:00 +0000</pubDate>
      
      <guid>/posts/nix-arch/</guid>
      <description>&lt;p&gt;Hi, I&amp;rsquo;m Matt and I&amp;rsquo;m one of those masochists who uses a chromebook as their personal development machine (not work though, I&amp;rsquo;m not &lt;em&gt;that&lt;/em&gt; crazy). A cool thing about Chrome OS&amp;rsquo;s Linux support is that you can swap the default, &lt;em&gt;boring&lt;/em&gt; Debian container for any LXC image. &lt;a href=&#34;https://wiki.archlinux.org/title/Chrome_OS_devices/Crostini&#34;&gt;Here&amp;rsquo;s an archwiki page on how to swap it to Arch!&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;A not-so-cool thing about that LXC setup is that there isn&amp;rsquo;t a NixOS LXC image available ðŸ˜¢. Instead, I set up an Arch Linux container with Nix and Home Manager. Best of both worlds I guess? Here&amp;rsquo;s how to do it.&lt;/p&gt;</description>
      <content>&lt;p&gt;Hi, I&amp;rsquo;m Matt and I&amp;rsquo;m one of those masochists who uses a chromebook as their personal development machine (not work though, I&amp;rsquo;m not &lt;em&gt;that&lt;/em&gt; crazy). A cool thing about Chrome OS&amp;rsquo;s Linux support is that you can swap the default, &lt;em&gt;boring&lt;/em&gt; Debian container for any LXC image. &lt;a href=&#34;https://wiki.archlinux.org/title/Chrome_OS_devices/Crostini&#34;&gt;Here&amp;rsquo;s an archwiki page on how to swap it to Arch!&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;A not-so-cool thing about that LXC setup is that there isn&amp;rsquo;t a NixOS LXC image available ðŸ˜¢. Instead, I set up an Arch Linux container with Nix and Home Manager. Best of both worlds I guess? Here&amp;rsquo;s how to do it.&lt;/p&gt;
&lt;h1 id=&#34;what-were-setting-up&#34;&gt;What we&amp;rsquo;re setting up&lt;/h1&gt;
&lt;p&gt;In these instructions, I&amp;rsquo;ll be setting up &lt;code&gt;nix&lt;/code&gt; and &lt;code&gt;home-manager&lt;/code&gt;. This setup doesn&amp;rsquo;t let you configure system-level things in nix like in NixOS, but you &lt;em&gt;can&lt;/em&gt; configure things for your user using &lt;code&gt;home-manager&lt;/code&gt;. If you set up &lt;a href=&#34;https://github.com/nix-community/nix-direnv&#34;&gt;nix-direnv&lt;/a&gt; in your home-manager config, you can add nix configurations for specific directories.&lt;/p&gt;
&lt;p&gt;This should work for any Arch Linux install, not just my weird LXC image.&lt;/p&gt;
&lt;h1 id=&#34;lets-go&#34;&gt;Let&amp;rsquo;s go!&lt;/h1&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Install nix&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo pacman -S nix
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Enable and start &lt;code&gt;nix-daemon&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo systemctl enable nix-daemon
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo systemctl start nix-daemon
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Add your user to the &lt;code&gt;nix-users&lt;/code&gt; group&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo gpasswd -a &amp;lt;user&amp;gt; nix-users
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Log out and back in again for the group change to take effect&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Add &lt;code&gt;nixpkgs&lt;/code&gt; and &lt;code&gt;home-manager&lt;/code&gt; channels&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;nix-channel --add https://nixos.org/channels/nixpkgs-unstable
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;nix-channel --update
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Install home-manager&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;export NIX_PATH&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;$HOME/.nix-defexpr/channels:/nix/var/nix/profiles/per-user/root/channels&lt;span style=&#34;color:#e6db74&#34;&gt;${&lt;/span&gt;NIX_PATH:+:$NIX_PATH&lt;span style=&#34;color:#e6db74&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;nix-shell &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;&amp;lt;home-manager&amp;gt;&amp;#39;&lt;/span&gt; -A install
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Take a look at &lt;code&gt;~/.config/nixpkgs/home.nix&lt;/code&gt;, make any desired changes, then run&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;home-manager switch
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;And that should be it! Enjoy!&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;nix-arch-cowsay.png&#34; alt=&#34;A nix shell running &amp;lsquo;cat /etc/os-release | cowsay&amp;rsquo;&#34;&gt;&lt;/p&gt;
&lt;h1 id=&#34;for-more-info&#34;&gt;For more info&amp;hellip;&lt;/h1&gt;
&lt;p&gt;These instructions are basically a condensed version of these two pages:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://wiki.archlinux.org/title/Nix&#34;&gt;Nix - ArchWiki&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://nix-community.github.io/home-manager/index.html#sec-install-standalone&#34;&gt;Home Manager standalone installation&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content>
    </item>
    
    <item>
      <title>Getting Dependabot and semantic-release to Play Nice</title>
      <link>/posts/semantic-release-dependabot/</link>
      <pubDate>Sat, 19 Jun 2021 00:00:00 +0000</pubDate>
      
      <guid>/posts/semantic-release-dependabot/</guid>
      <description>&lt;p&gt;The other day, GitHub sent me a notification that there were a couple security vulnerabilities in the dependencies of one of my personal projects, &lt;a href=&#34;https://github.com/mattbun/castaway&#34;&gt;castaway&lt;/a&gt;. Having used Dependabot at work, I figured I&amp;rsquo;d enable it and get that vulnerability taken care of.&lt;/p&gt;
&lt;p&gt;After I merged one of Dependabot&amp;rsquo;s PRs, I was shocked (ðŸ˜±) to find that semantic-release hadn&amp;rsquo;t made a release for it. Dependabot prefixed the commit with &lt;code&gt;build(deps):&lt;/code&gt;, and semantic-release only creates releases for commits with prefixes &lt;code&gt;fix&lt;/code&gt; and &lt;code&gt;feat&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;What&amp;rsquo;s the point of a security update if it doesn&amp;rsquo;t actually build a new image? Looks like I&amp;rsquo;ve got some work to do.&lt;/p&gt;</description>
      <content>&lt;p&gt;The other day, GitHub sent me a notification that there were a couple security vulnerabilities in the dependencies of one of my personal projects, &lt;a href=&#34;https://github.com/mattbun/castaway&#34;&gt;castaway&lt;/a&gt;. Having used Dependabot at work, I figured I&amp;rsquo;d enable it and get that vulnerability taken care of.&lt;/p&gt;
&lt;p&gt;After I merged one of Dependabot&amp;rsquo;s PRs, I was shocked (ðŸ˜±) to find that semantic-release hadn&amp;rsquo;t made a release for it. Dependabot prefixed the commit with &lt;code&gt;build(deps):&lt;/code&gt;, and semantic-release only creates releases for commits with prefixes &lt;code&gt;fix&lt;/code&gt; and &lt;code&gt;feat&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;What&amp;rsquo;s the point of a security update if it doesn&amp;rsquo;t actually build a new image? Looks like I&amp;rsquo;ve got some work to do.&lt;/p&gt;
&lt;h1 id=&#34;approach-1---change-dependabot-commit-messages&#34;&gt;Approach #1 - Change Dependabot Commit Messages&lt;/h1&gt;
&lt;p&gt;You can change Dependabot&amp;rsquo;s commit messages! And not only that, you can change the commit prefix depending on whether its a dev or production dependency.&lt;/p&gt;
&lt;p&gt;I configured dependabot to use the commit prefix &lt;code&gt;fix(deps)&lt;/code&gt; for production dependencies with the following in &lt;code&gt;.github/dependabot.yml&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;version&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;updates&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  - &lt;span style=&#34;color:#f92672&#34;&gt;package-ecosystem&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;npm&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;directory&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;schedule&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#f92672&#34;&gt;interval&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;daily&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;commit-message&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#f92672&#34;&gt;prefix&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;fix&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#f92672&#34;&gt;prefix-development&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;build&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#f92672&#34;&gt;include&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;scope&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;allow&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      - &lt;span style=&#34;color:#f92672&#34;&gt;dependency-type&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;production&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This works! semantic-release bumps the patch version and triggers a new build when production dependencies are updated. Dev dependencies are still prefixed with &lt;code&gt;build&lt;/code&gt;, which semantic-release ignores.&lt;/p&gt;
&lt;h2 id=&#34;but-theres-a-catch&#34;&gt;But there&amp;rsquo;s a catch!&lt;/h2&gt;
&lt;p&gt;Dependabot comes in a couple different flavors:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;GitHub Dependabot - this is enabled by having a &lt;code&gt;.github/dependabot.yml&lt;/code&gt; file in your repository&lt;/li&gt;
&lt;li&gt;GitHub Dependabot Security Updates - this is enabled in your repository&amp;rsquo;s &amp;ldquo;Security &amp;amp; Analysis&amp;rdquo; section&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The dependabot configuration from above only affects the first one. Security updates &lt;a href=&#34;https://github.community/t/how-to-get-dependabot-to-trigger-for-security-updates-only/117257/5&#34;&gt;cannot be configured&lt;/a&gt;. This also means that the configuration from above will enable &lt;em&gt;all&lt;/em&gt; dependency updates, not just the ones with vulnerabilities.&lt;/p&gt;
&lt;p&gt;Now this is probably fine for plenty of projects. Keeping dependencies up-to-date is noble. If you&amp;rsquo;re fine with that, you&amp;rsquo;re done! No need to read the next section.&lt;/p&gt;
&lt;p&gt;But the project I&amp;rsquo;m adding this to isn&amp;rsquo;t worth all that hassle. I&amp;rsquo;m fine with making some security updates here and there, but I don&amp;rsquo;t want to spend all of my time updating dependencies unnecessarily.&lt;/p&gt;
&lt;p&gt;I guess I have to give up the ability to configure Dependabot to get what I want ðŸ¤¦.&lt;/p&gt;
&lt;h1 id=&#34;approach-2---configure-semantic-release-to-understand-dependabot-commits&#34;&gt;Approach #2 - Configure semantic-release to Understand Dependabot Commits&lt;/h1&gt;
&lt;p&gt;We can&amp;rsquo;t change how Dependabot Security Updates works, so we&amp;rsquo;ll have to work with its default commit format: &lt;code&gt;build(deps)&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&#34;commit-analyzer-changes&#34;&gt;commit-analyzer Changes&lt;/h2&gt;
&lt;p&gt;First, we&amp;rsquo;ll need to configure semantic-release to see dependabot commits as &amp;ldquo;patch&amp;rdquo;-worthy updates. That can be done by adding a &lt;code&gt;releaseRule&lt;/code&gt; to the commit-analyzer configuration, like the following:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;release&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#75715e&#34;&gt;// ...
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;plugins&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@semantic-release/commit-analyzer&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;preset&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;conventionalcommits&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;releaseRules&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;type&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;build&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;scope&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;deps&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;release&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;patch&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// ...
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;  ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Note that dev dependencies use a different scope, &lt;code&gt;deps-dev&lt;/code&gt;, so those updates will continue to be ignored by semantic-release.&lt;/p&gt;
&lt;h2 id=&#34;release-notes-generator-changes&#34;&gt;release-notes-generator Changes&lt;/h2&gt;
&lt;p&gt;With just the commit-analyzer changes above, Dependabot updates will create releases, but the release notes in the GitHub release will be blank. That&amp;rsquo;s not particularly helpful. To fix that, we&amp;rsquo;ll need to make some configuration changes to semantic-release&amp;rsquo;s release-notes-generator.&lt;/p&gt;
&lt;p&gt;First off, you&amp;rsquo;ll need to add &lt;a href=&#34;https://www.npmjs.com/package/conventional-changelog-conventionalcommits&#34;&gt;conventional-changelog-conventionalcommits&lt;/a&gt; to your dev dependencies, if you don&amp;rsquo;t already have it:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;yarn add -D conventional-changelog-conventionalcommits
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Then configure the &lt;code&gt;release-notes-generator&lt;/code&gt; plugin like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;release&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#75715e&#34;&gt;// ...
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;plugins&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// ...
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;@semantic-release/release-notes-generator&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;preset&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;conventionalcommits&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;presetConfig&amp;#34;&lt;/span&gt;: {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;types&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;type&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;feat&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;section&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Features&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;type&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;fix&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;section&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Bug Fixes&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;type&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;build&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;section&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Dependencies and Other Build Updates&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;hidden&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#66d9ef&#34;&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// ...
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;  ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This puts any &lt;code&gt;build&lt;/code&gt; commits in a new &amp;ldquo;Dependencies and Other Build Updates&amp;rdquo; section. That &lt;code&gt;&amp;quot;hidden&amp;quot;: false&lt;/code&gt; is important! If you don&amp;rsquo;t include it, it&amp;rsquo;ll default to &lt;code&gt;true&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Note that this change will put other &lt;code&gt;build&lt;/code&gt; commits in your changelog as well, though they may not trigger a release on their own.&lt;/p&gt;
&lt;h3 id=&#34;do-i-have-to-use-the-conventionalcommits-preset&#34;&gt;Do I have to use the conventionalcommits preset?&lt;/h3&gt;
&lt;p&gt;I can&amp;rsquo;t speak for the other presets, but &lt;code&gt;angular&lt;/code&gt; doesn&amp;rsquo;t support this as far as I can tell. The &lt;code&gt;conventionalcommits&lt;/code&gt; preset has an &lt;a href=&#34;https://github.com/conventional-changelog/conventional-changelog-config-spec/blob/master/versions/2.1.0/README.md&#34;&gt;extensive configuration spec&lt;/a&gt; while &lt;a href=&#34;https://github.com/conventional-changelog/conventional-changelog/tree/master/packages/conventional-changelog-angular#readme&#34;&gt;the angular one doesn&amp;rsquo;t seem to have any options?&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;can-i-see-all-these-changes-in-one-place&#34;&gt;Can I see all these changes in one place?&lt;/h2&gt;
&lt;p&gt;Yep, &lt;a href=&#34;https://github.com/mattbun/castaway/blob/bc4595ff2f52bf2f7d8b929f3c386f07472b2342/package.json#L36&#34;&gt;see it in action here&lt;/a&gt;&lt;/p&gt;</content>
    </item>
    
    <item>
      <title>Removing Old Torrents Using a Raspberry Pi Cluster</title>
      <link>/posts/rpi-cluster-removing-torrents/</link>
      <pubDate>Tue, 23 Feb 2021 00:00:00 +0000</pubDate>
      
      <guid>/posts/rpi-cluster-removing-torrents/</guid>
      <description>&lt;p&gt;My new Raspberry Pi cluster is a little unstable and pretty limited since the nodes have just 1GB of memory. What the heck could I possibly use this for?&lt;/p&gt;
&lt;p&gt;Turns out it&amp;rsquo;s great at running simple cron jobs. In this case, one that cleans up old torrents on a remote qbittorrent server.&lt;/p&gt;</description>
      <content>&lt;p&gt;My new Raspberry Pi cluster is a little unstable and pretty limited since the nodes have just 1GB of memory. What the heck could I possibly use this for?&lt;/p&gt;
&lt;p&gt;Turns out it&amp;rsquo;s great at running simple cron jobs. In this case, one that cleans up old torrents on a remote qbittorrent server.&lt;/p&gt;
&lt;h1 id=&#34;the-problem&#34;&gt;The Problem&lt;/h1&gt;
&lt;p&gt;I download a lot of uhh&amp;hellip; &lt;em&gt;linux distributions&lt;/em&gt; using qbittorrent. One thing that&amp;rsquo;s always bugged me about it is that it doesn&amp;rsquo;t automatically remove old downloads. My home server is completely automated &lt;em&gt;except&lt;/em&gt; it won&amp;rsquo;t clean these up.&lt;/p&gt;
&lt;p&gt;This isn&amp;rsquo;t just a problem with qbittorrent, I&amp;rsquo;ve wanted this on every bittorrent client I&amp;rsquo;ve used. There &lt;em&gt;has&lt;/em&gt; to be a way to do this.&lt;/p&gt;
&lt;h1 id=&#34;the-solution&#34;&gt;The Solution&lt;/h1&gt;
&lt;p&gt;qbittorrent has an API! It&amp;rsquo;s kind of hard to find since their wiki seems to be world writable (&lt;a href=&#34;https://github.com/qbittorrent/qBittorrent/wiki/Web-API-Documentation&#34;&gt;?&lt;/a&gt;) but &lt;a href=&#34;https://github.com/qbittorrent/qBittorrent/wiki/Web-API-Documentation/87ec6b289ea5376b648e8cbb1373fb538da9f01d&#34;&gt;eventually you&amp;rsquo;ll find it&lt;/a&gt;. There&amp;rsquo;s even &lt;a href=&#34;https://www.npmjs.com/package/qbittorrent-api-v2&#34;&gt;an npm package&lt;/a&gt;, though I didn&amp;rsquo;t have great luck with that.&lt;/p&gt;
&lt;p&gt;Anyway, once I found the API documentation, I was able to put this together:&lt;/p&gt;
&lt;h2 id=&#34;introducing-qbittorrent-reaper&#34;&gt;Introducing qbittorrent-reaper&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://github.com/mattbun/qbittorrent-reaper&#34;&gt;qbittorrent-reaper&lt;/a&gt;&lt;/strong&gt; is a simple Node.js application, written in Typescript, that removes torrents older than a given age from qbittorrent.&lt;/p&gt;
&lt;p&gt;You can find a docker image for it &lt;a href=&#34;https://hub.docker.com/r/mattbun/qbittorrent-reaper&#34;&gt;here&lt;/a&gt;!&lt;/p&gt;
&lt;h3 id=&#34;how-do-you-run-it-on-a-schedule&#34;&gt;How Do You Run It on a Schedule?&lt;/h3&gt;
&lt;p&gt;qbittorrent-reaper won&amp;rsquo;t run on a schedule on its own. It&amp;rsquo;s meant to be run as a Kubernetes CronJob. I&amp;rsquo;m planning on putting up a helm chart for it, but for now you could run the following with &lt;code&gt;kubectl apply&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;apiVersion&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;batch/v1beta1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;kind&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;CronJob&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;metadata&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;qbittorrent-reaper&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;schedule&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;0 0 * * *&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;# daily at midnight&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;concurrencyPolicy&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Replace&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;jobTemplate&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#f92672&#34;&gt;template&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;spec&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#f92672&#34;&gt;restartPolicy&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;OnFailure&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#f92672&#34;&gt;containers&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;qbittorrent-reaper&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#f92672&#34;&gt;image&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;mattbun/qbittorrent-reaper:main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#f92672&#34;&gt;env&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;QBITTORRENT_HOST&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;value&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;192.168.1&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;.x&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;QBITTORRENT_PORT&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;value&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;8080&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;QBITTORRENT_USERNAME&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;value&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;totallyCoolUsername&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;QBITTORRENT_PASSWORD&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;value&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;this shouldn&amp;#39;t be here&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;MAX_TORRENT_AGE&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;value&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;2w&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;(you probably don&amp;rsquo;t want the password exposed like that)&lt;/p&gt;
&lt;h3 id=&#34;does-it-run-on-arm-processors&#34;&gt;Does It Run on ARM Processors?&lt;/h3&gt;
&lt;p&gt;The &lt;a href=&#34;https://www.docker.com/blog/docker-v2-github-action-is-now-ga/&#34;&gt;new docker/build-push-action/v2 action&lt;/a&gt; makes it super easy to build the image for multiple CPU architectures (including my cluster&amp;rsquo;s &lt;code&gt;arm/v7&lt;/code&gt; ðŸŽ‰). It&amp;rsquo;s as easy as this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;- &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Set up QEMU&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;uses&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;docker/setup-qemu-action@v1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;- &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Set up Docker Buildx&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;uses&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;docker/setup-buildx-action@v1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;- &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Login to DockerHub&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;uses&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;docker/login-action@v1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;with&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;username&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;${{ secrets.DOCKERHUB_USERNAME }}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;password&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;${{ secrets.DOCKERHUB_TOKEN }}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;- &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Build and push&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;uses&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;docker/build-push-action@v2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;with&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;context&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;file&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;./Dockerfile&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;platforms&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;linux/amd64,linux/arm/v7,linux/arm64&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;push&lt;/span&gt;: &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;tags&lt;/span&gt;: |&lt;span style=&#34;color:#e6db74&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      mattbun/qbittorrent-reaper:latest
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      mattbun/qbittorrent-reaper:main
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      mattbun/qbittorrent-reaper:${{ github.event.release.tag_name }}&lt;/span&gt;      
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;also-id-like-to-point-out&#34;&gt;Also I&amp;rsquo;d Like to Point Out&amp;hellip;&lt;/h3&gt;
&lt;p&gt;Versioning and releases are handled automatically by &lt;a href=&#34;https://github.com/semantic-release/semantic-release&#34;&gt;semantic-release&lt;/a&gt; as long as I remember to stick to semantic commits. This means that the whole release process is automated! Whenever I push a commit to &lt;code&gt;main&lt;/code&gt; that &lt;code&gt;semantic-release&lt;/code&gt; deems worthy of a version bump, it creates a release in github and builds a new docker image.&lt;/p&gt;
&lt;p&gt;I&amp;rsquo;m &lt;em&gt;really&lt;/em&gt; excited about this. I might just make a template out of it.&lt;/p&gt;
&lt;h1 id=&#34;back-to-the-cluster&#34;&gt;Back to the cluster&lt;/h1&gt;
&lt;p&gt;Turns out my slightly unstable cluster is perfect for running this:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;kubectl_jobs.png&#34; alt=&#34;Three successful jobs!&#34;&gt;&lt;/p&gt;
&lt;p&gt;This has been working great for the last few weeks now. Old torrents are getting removed and my cluster has that warm feeling of accomplishment. Win win.&lt;/p&gt;</content>
    </item>
    
    <item>
      <title>Saibamen Attack! Building a Raspberry Pi Cluster</title>
      <link>/posts/rpi-k3s-cluster/</link>
      <pubDate>Sun, 21 Feb 2021 00:00:00 +0000</pubDate>
      
      <guid>/posts/rpi-k3s-cluster/</guid>
      <description>&lt;p&gt;Over the holidays I made a &lt;a href=&#34;https://k3s.io/&#34;&gt;k3s&lt;/a&gt; (that&amp;rsquo;s Kubernetes minus 5) cluster out of Raspberry Pis I had lying around. And while it&amp;rsquo;s &lt;em&gt;extremely&lt;/em&gt; cool, it&amp;rsquo;s also &lt;em&gt;pretty&lt;/em&gt; unstable.&lt;/p&gt;
&lt;p&gt;In this post, I&amp;rsquo;ll outline what this new cluster looks like and go into detail on how I set it up. At the end, I&amp;rsquo;ll talk a little bit about why I won&amp;rsquo;t be entrusting it with my most important tasks just yet.&lt;/p&gt;</description>
      <content>&lt;p&gt;Over the holidays I made a &lt;a href=&#34;https://k3s.io/&#34;&gt;k3s&lt;/a&gt; (that&amp;rsquo;s Kubernetes minus 5) cluster out of Raspberry Pis I had lying around. And while it&amp;rsquo;s &lt;em&gt;extremely&lt;/em&gt; cool, it&amp;rsquo;s also &lt;em&gt;pretty&lt;/em&gt; unstable.&lt;/p&gt;
&lt;p&gt;In this post, I&amp;rsquo;ll outline what this new cluster looks like and go into detail on how I set it up. At the end, I&amp;rsquo;ll talk a little bit about why I won&amp;rsquo;t be entrusting it with my most important tasks just yet.&lt;/p&gt;
&lt;h1 id=&#34;overview&#34;&gt;Overview&lt;/h1&gt;
&lt;p&gt;&lt;img src=&#34;saibamen_diagram.svg&#34; alt=&#34;saibamen diagram&#34;&gt;&lt;/p&gt;
&lt;p&gt;To keep it simple, this cluster has just two nodes. In keeping with my tradition of naming computers after Dragon Ball Z villains, it&amp;rsquo;s collectively named the &lt;code&gt;saibamen&lt;/code&gt; cluster (after those &lt;a href=&#34;https://dragonball.fandom.com/wiki/Saibamen&#34;&gt;nasty little green aliens&lt;/a&gt; Nappa and Vegeta unleashed on our unsuspecting Z Fighters).&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;saibaman1&lt;/code&gt; -&amp;gt; master node
&lt;ul&gt;
&lt;li&gt;Also runs a DHCP server, assigning IP addresses on the cluster network&lt;/li&gt;
&lt;li&gt;Connected to the outside network over WiFi and shares that connection with the rest of the cluster&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;saibaman2&lt;/code&gt; -&amp;gt; worker node
&lt;ul&gt;
&lt;li&gt;Only connected to the cluster network&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;the-hardware&#34;&gt;The Hardware&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;2 x Raspberry Pi 3
&lt;ul&gt;
&lt;li&gt;Note that &lt;a href=&#34;https://github.com/kubernetes/kubeadm/issues/253#issuecomment-296738890&#34;&gt;k3s doesn&amp;rsquo;t support ARMv6&lt;/a&gt;, so you need at least a Pi 2. Older Pis like the Pi 1 and Pi Zero aren&amp;rsquo;t supported.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;2 x MicroSD cards&lt;/li&gt;
&lt;li&gt;1 x Ethernet switch&lt;/li&gt;
&lt;li&gt;1 x USB power hub (I got &lt;a href=&#34;https://www.amazon.com/gp/product/B00P933OJC&#34;&gt;this one&lt;/a&gt;, though I wonder if this is the culprit for some of the issues I&amp;rsquo;ve had)&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;the-software&#34;&gt;The Software&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Raspberry Pi OS (formerly known as raspbian)
&lt;ul&gt;
&lt;li&gt;I tried NixOS first (I&amp;rsquo;m a bit of a fanboy) but had some trouble getting it working. Maybe someday!&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;k3s
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;Why k3s?&lt;/em&gt; Because it&amp;rsquo;s easy to set up and getting it working on Raspberry Pi is well documented.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;dnsmasq - the DHCP server running on the master node&lt;/li&gt;
&lt;li&gt;iptables - Used to share wifi connection with the rest of the cluster&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;setup&#34;&gt;Setup&lt;/h1&gt;
&lt;h2 id=&#34;installing-and-configuring-linux&#34;&gt;Installing and Configuring Linux&lt;/h2&gt;
&lt;p&gt;Do this on both Pis.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;em&gt;Use your favorite method to install Raspberry Pi OS on the microSD card.&lt;/em&gt; Personally, I like good ol&amp;rsquo; &lt;code&gt;dd&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo dd bs&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;4M &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;path/to/image.img of&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;/dev/sdX conv&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;fsync
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;You&amp;rsquo;ll likely want to run &lt;code&gt;sudo raspi-config&lt;/code&gt; and change a few things:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;In `System Options`,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  * Set a password
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  * Set a hostname
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;In `Interface Options`,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  * Enable SSH access
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;In `Localisation Options`,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  * Set locale
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  * Set timezone
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  * Enable WiFi (on master only)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Install your favorite editor (Vim, obvs)&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo apt install vim
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Important!&lt;/strong&gt; Add this line to the end of &lt;code&gt;/boot/cmdline.txt&lt;/code&gt; so k3s can run containers&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-txt&#34; data-lang=&#34;txt&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Reboot!&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo reboot
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;networking&#34;&gt;Networking&lt;/h2&gt;
&lt;p&gt;To keep cluster traffic isolated from my home network, the master node serves as a DHCP server and shares its WiFi connection over ethernet. It ends up looking something like this:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;Wifi (192.168.1.x) -&amp;gt; saibaman1 -&amp;gt; Ethernet (192.168.2.x) -&amp;gt; saibaman2
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;sharing-a-wifi-connection&#34;&gt;Sharing a WiFi Connection&lt;/h3&gt;
&lt;p&gt;The following is copied with a few small changes (mostly that I changed it to use &lt;code&gt;192.168.2.x&lt;/code&gt;) from &lt;a href=&#34;https://www.raspberrypi.org/forums/viewtopic.php?t=223295&#34;&gt;this excellent forum post&lt;/a&gt;.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Configure the Pi&amp;rsquo;s WiFi connection. Check out &lt;a href=&#34;https://www.raspberrypi.org/documentation/configuration/wireless/wireless-cli.md&#34;&gt;this guide&lt;/a&gt; for how to do that. Once you&amp;rsquo;ve set up WiFi, you&amp;rsquo;ll probably want to disconnect it from ethernet if it&amp;rsquo;s connected. Running multiple DHCP servers can get weird pretty fast.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Install dnsmasq&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo apt install dnsmasq
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Set a static IP address for &lt;code&gt;eth0&lt;/code&gt;. Open &lt;code&gt;/etc/dhcpcd.conf&lt;/code&gt; and add this to the end:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code class=&#34;language-conf&#34; data-lang=&#34;conf&#34;&gt;interface eth0
static ip_address=192.168.2.1/24
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Save or remove the original &lt;code&gt;dnsmasq.conf&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo mv /etc/dnsmasq.conf /etc/dnsmaq.conf.orig
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Open &lt;code&gt;/etc/dnsmasq.conf&lt;/code&gt; and add this:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code class=&#34;language-conf&#34; data-lang=&#34;conf&#34;&gt;interface=eth0
dhcp-range=192.168.2.10,192.168.2.250,255.255.255.0,12h
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Open &lt;code&gt;/etc/sysctl.conf&lt;/code&gt; and uncomment&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code class=&#34;language-conf&#34; data-lang=&#34;conf&#34;&gt;net.ipv4.ip_forward=1
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Open &lt;code&gt;/etc/rc.local&lt;/code&gt; and add this line above &lt;code&gt;exit 0&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;iptables -t nat -A  POSTROUTING -o wlan0 -j MASQUERADE
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Reboot!&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo reboot
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;setting-up-k3s&#34;&gt;Setting up k3s&lt;/h2&gt;
&lt;h3 id=&#34;install-k3s-on-the-master-node&#34;&gt;Install k3s on the master node&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;ssh&lt;/code&gt; into the master pi&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Install &lt;code&gt;k3s&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;curl -sfL https://get.k3s.io | sh -
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Check to see if it&amp;rsquo;s working. Run the following to see what nodes have been added to the cluster, you should see one node:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo kubectl get nodes
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Copy the join token, you&amp;rsquo;ll need this to add nodes to the cluster&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo cat /var/lib/rancher/k3s/server/node-token
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;install-k3s-on-the-worker-node&#34;&gt;Install k3s on the worker node&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;ssh&lt;/code&gt; into the worker pi&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Install &lt;code&gt;k3s&lt;/code&gt; and be sure to pass the token you copied earlier and the IP address of the master node:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;curl -sfL http://get.k3s.io | K3S_URL&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;https://192.168.2.1:6443 &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;K3S_TOKEN&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&amp;lt;join-token&amp;gt; sh -
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Once that&amp;rsquo;s done, check to see if it&amp;rsquo;s working. &lt;code&gt;ssh&lt;/code&gt; back into the master node and run the following command. You should see two nodes:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo kubectl get nodes
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;grab-your-kubeconfig&#34;&gt;Grab your kubeconfig&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;ssh&lt;/code&gt; into the master node&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Copy its kubeconfig&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo cat /etc/rancher/k3s/k3s.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Return to the computer you&amp;rsquo;d like to put the kubeconfig onto&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Make a &lt;code&gt;.kube&lt;/code&gt; folder if one doesn&amp;rsquo;t exist already&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mkdir .kube
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Open &lt;code&gt;.kube/config&lt;/code&gt; and paste the contents of the file you copied earlier&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Replace &lt;code&gt;localhost&lt;/code&gt; with the IP address of the master node relative to the computer you&amp;rsquo;re setting this up on:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;server&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;https://192.168.1.x:6443&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Change the permissions of the new file so kubectl won&amp;rsquo;t complain about it (oh &lt;em&gt;and&lt;/em&gt; because it&amp;rsquo;s the right thing to do):&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;chmod &lt;span style=&#34;color:#ae81ff&#34;&gt;600&lt;/span&gt; ~/.kube/config
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Try it out!&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;kubectl get nodes
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&#34;so-how-is-it&#34;&gt;So How Is It?&lt;/h1&gt;
&lt;p&gt;Well, let&amp;rsquo;s just say I wouldn&amp;rsquo;t put anything too important on it.&lt;/p&gt;
&lt;p&gt;k3s crashes when I push the cluster to its limits, like when installing a particularly complex Helm chart. To make matters worse, that crash can put it in a state where it can&amp;rsquo;t start up again. I&amp;rsquo;ve had to reinstall it several times now.&lt;/p&gt;
&lt;p&gt;I have a couple theories for why this happens.&lt;/p&gt;
&lt;h2 id=&#34;power-issues&#34;&gt;Power Issues?&lt;/h2&gt;
&lt;p&gt;Raspberry Pis are notoriously sensitive to power supply issues. Remember that xkcd about how clicking links in a Wikipedia article will eventually lead you to &amp;ldquo;Philosophy&amp;rdquo;? I&amp;rsquo;ve found that debugging any Raspberry Pi issue will eventually lead you to a storefront selling a better power supply. It&amp;rsquo;s weird how that always happens.&lt;/p&gt;
&lt;p&gt;On one hand, it could be that my USB hub isn&amp;rsquo;t putting out enough power. I didn&amp;rsquo;t really look into it too much to be honest. I didn&amp;rsquo;t feel like buying new usb chargers and making the wiring more obnoxious for something that &lt;em&gt;might&lt;/em&gt; be the issue.&lt;/p&gt;
&lt;p&gt;I&amp;rsquo;m wondering if one of my Micro USB cables is to blame. Running &lt;code&gt;vcgencmd measure_volts&lt;/code&gt; repeatedly under high CPU usage showed that one of my cables had a lower maximum voltage. I swapped it out and I feel like it&amp;rsquo;s been a bit better but it might just be wishful thinking.&lt;/p&gt;
&lt;h2 id=&#34;are-my-raspberry-pis-too-slow&#34;&gt;Are My Raspberry Pis Too Slow?&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://medium.com/@ikarus/run-kubernetes-on-your-raspberry-pi-cluster-with-k3s-ac3687d6eb1a&#34;&gt;This article&lt;/a&gt; makes the case that the Raspberry Pis I&amp;rsquo;m using are too slow to reliably run etcd (which is used by k3s to keep track of cluster state). Before the Raspberry Pi 4; Ethernet, USB, and the SD card are all on one USB 2.0 bus. I&amp;rsquo;m likely making this worse by having the same Pi handle both the control plane &lt;em&gt;and&lt;/em&gt; the cluster&amp;rsquo;s network connection.&lt;/p&gt;
&lt;h2 id=&#34;whatever-its-good-enough&#34;&gt;Whatever, It&amp;rsquo;s Good Enough&lt;/h2&gt;
&lt;p&gt;Despite all that, this has been a fun project. I built a kubernetes cluster on the cheap, mostly using parts I already had. As long as I don&amp;rsquo;t push it too hard, it works just fine!&lt;/p&gt;</content>
    </item>
    
    <item>
      <title>Switching to Hugo</title>
      <link>/posts/switching-to-hugo/</link>
      <pubDate>Sat, 03 Oct 2020 00:00:00 +0000</pubDate>
      
      <guid>/posts/switching-to-hugo/</guid>
      <description>&lt;p&gt;Welp, I switched this website from &lt;a href=&#34;https://www.gatsbyjs.com/&#34;&gt;Gatsby&lt;/a&gt; to &lt;a href=&#34;https://gohugo.io/&#34;&gt;Hugo&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This reminds me of my distro-hoppin&amp;rsquo; days, when I used to spend nights installing different Linux distributions and then meticulously configuring them to my liking. &amp;ldquo;Oh man, I can get &lt;em&gt;so&lt;/em&gt; much done with this distro!&amp;rdquo;, I&amp;rsquo;d say. I spent so mush time trying to find that perfect setup, that I didn&amp;rsquo;t spend much time actually &lt;em&gt;using&lt;/em&gt; them to get things done.&lt;/p&gt;
&lt;p&gt;Well, I guess I haven&amp;rsquo;t changed much. After writing a single post, I decided to try something else for this website. Let&amp;rsquo;s at least talk about the notable changes in a &lt;em&gt;second&lt;/em&gt; post&amp;hellip;&lt;/p&gt;</description>
      <content>&lt;p&gt;Welp, I switched this website from &lt;a href=&#34;https://www.gatsbyjs.com/&#34;&gt;Gatsby&lt;/a&gt; to &lt;a href=&#34;https://gohugo.io/&#34;&gt;Hugo&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This reminds me of my distro-hoppin&amp;rsquo; days, when I used to spend nights installing different Linux distributions and then meticulously configuring them to my liking. &amp;ldquo;Oh man, I can get &lt;em&gt;so&lt;/em&gt; much done with this distro!&amp;rdquo;, I&amp;rsquo;d say. I spent so mush time trying to find that perfect setup, that I didn&amp;rsquo;t spend much time actually &lt;em&gt;using&lt;/em&gt; them to get things done.&lt;/p&gt;
&lt;p&gt;Well, I guess I haven&amp;rsquo;t changed much. After writing a single post, I decided to try something else for this website. Let&amp;rsquo;s at least talk about the notable changes in a &lt;em&gt;second&lt;/em&gt; post&amp;hellip;&lt;/p&gt;
&lt;h1 id=&#34;go-ing-there-with-packagejson&#34;&gt;Go-ing There with package.json&lt;/h1&gt;
&lt;p&gt;Hugo doesn&amp;rsquo;t need a &lt;code&gt;package.json&lt;/code&gt; but I couldn&amp;rsquo;t bring myself to delete it. Old habits die hard I guess. I added a couple things to it to make it feel worthwhile:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;I use &lt;a href=&#34;https://classic.yarnpkg.com/en/docs/workspaces/&#34;&gt;yarn workspaces&lt;/a&gt; to install dependencies for the theme when I run &lt;code&gt;yarn install&lt;/code&gt; from the repo&amp;rsquo;s base directory. All I had to do was add this to the package.json:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;workspaces&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;themes/terminal&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;]&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;I added &lt;a href=&#34;https://www.npmjs.com/package/hugo-bin&#34;&gt;this cool npm module that installs a hugo binary&lt;/a&gt; to the dev dependencies. If I want to work on this website on a new computer, I only have to run &lt;code&gt;yarn install&lt;/code&gt;!&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;github-actions-rewind-it-back&#34;&gt;Github Actions: Rewind It Back&lt;/h1&gt;
&lt;p&gt;With Gatsby, I used &lt;a href=&#34;https://github.com/enriikke/gatsby-gh-pages-action&#34;&gt;this action&lt;/a&gt; to deploy it. But this time around, I felt like I had a better understanding of what was going on here. With a little help from &lt;a href=&#34;https://medium.com/zendesk-engineering/a-github-actions-workflow-to-generate-publish-your-hugo-website-f36375e56cf7&#34;&gt;this article&lt;/a&gt;, I (mostly) wrote it by hand. The process is simple:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Checkout the website&amp;rsquo;s git repository&lt;/li&gt;
&lt;li&gt;Run &lt;code&gt;yarn install&lt;/code&gt; to install the theme&amp;rsquo;s npm dependencies&lt;/li&gt;
&lt;li&gt;Run &lt;code&gt;hugo&lt;/code&gt; to build the website&lt;/li&gt;
&lt;li&gt;Publish the contents of the &lt;code&gt;public&lt;/code&gt; directory (where &lt;code&gt;hugo&lt;/code&gt; builds to) to the &lt;code&gt;gh-pages&lt;/code&gt; branch.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Those &lt;code&gt;package.json&lt;/code&gt; changes I mentioned earlier came in handy here. Here&amp;rsquo;s what it looks like:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;jobs&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;build&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;runs-on&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;ubuntu-latest&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;steps&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Checkout&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;uses&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;actions/checkout@v2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;with&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#f92672&#34;&gt;submodules&lt;/span&gt;: &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#f92672&#34;&gt;fetch-depth&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Use Node.js&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;uses&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;actions/setup-node@v1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;with&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#f92672&#34;&gt;node-version&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;12.&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;x&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#75715e&#34;&gt;# This also installs Hugo since it&amp;#39;s in my dependencies!&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Install dependencies&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;run&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;yarn install&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Build&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;run&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;yarn build&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Create CNAME file&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;run&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;cp CNAME public/CNAME&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      - &lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Publish&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;uses&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;peaceiris/actions-gh-pages@v3&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;with&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#f92672&#34;&gt;github_token&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;${{ secrets.GITHUB_TOKEN }}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#f92672&#34;&gt;publish_dir&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;./public&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#f92672&#34;&gt;user_name&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;github-actions[bot]&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#f92672&#34;&gt;user_email&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;github-actions[bot]@users.noreply.github.com&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#f92672&#34;&gt;commit_message&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;${{ github.event.head_commit.message }}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h1 id=&#34;using-timestamps-in-folder-names&#34;&gt;Using Timestamps in Folder Names&lt;/h1&gt;
&lt;p&gt;I really like the idea of prefixing post names with &lt;code&gt;YYYY-MM-DD&lt;/code&gt; so they&amp;rsquo;re listed in date order when listed alphabetically. Like this:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ ls content/posts
2020-08-02-creating-this-website/
2020-10-03-switching-to-hugo/
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Hugo has a way to get the creation date from those timestamps! See the &lt;code&gt;:filename&lt;/code&gt; date handler &lt;a href=&#34;https://gohugo.io/getting-started/configuration/#configure-dates&#34;&gt;here&lt;/a&gt;. In my &lt;code&gt;config.toml&lt;/code&gt;, I have:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-toml&#34; data-lang=&#34;toml&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[&lt;span style=&#34;color:#a6e22e&#34;&gt;frontmatter&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;date&lt;/span&gt; = [&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;:filename&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;:default&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You can also get the date that it was last updated from git by enabling &lt;a href=&#34;https://gohugo.io/variables/git/&#34;&gt;gitinfo&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-toml&#34; data-lang=&#34;toml&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;enableGitInfo&lt;/span&gt; = &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;I don&amp;rsquo;t think I&amp;rsquo;ve ever been so excited about creation and updated dates before! These changes give me the file structure I want, keep the creation dates in a single place, and make the updated dates entirely automatic! ðŸ’ƒ&lt;/p&gt;
&lt;h4 id=&#34;remove-timestamp-from-title&#34;&gt;Remove Timestamp from Title&lt;/h4&gt;
&lt;p&gt;At this point, if you run&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;$ hugo new posts/2020-10-03-switching-to-hugo
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;It gets the creation date from the folder name as expected, but the new post has the title &amp;ldquo;2020 10 03 Switching To Hugo&amp;rdquo;. How do I get that timestamp out of there? After plenty of trial and error, I finally came up with this template for the post archetype:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;title: &amp;#34;{{ replace ( replaceRE &amp;#34;^\\d+-\\d+-\\d+-&amp;#34; &amp;#34;&amp;#34; .Name 1 ) &amp;#34;-&amp;#34; &amp;#34; &amp;#34; | title }}&amp;#34;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;That template removes the timestamp, then replaces hyphens with spaces, then capitalizes the first letters of each word. Note that you can nest templates with &lt;em&gt;parentheses&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Now when I run the same command, the title is &amp;ldquo;Switching To Hugo&amp;rdquo;. Ahh much better.&lt;/p&gt;
&lt;h1 id=&#34;thats-all-folks&#34;&gt;That&amp;rsquo;s All Folks&lt;/h1&gt;
&lt;p&gt;That&amp;rsquo;s it for now, we&amp;rsquo;ll see how Hugo works out. If I switch again, I&amp;rsquo;ll be sure to post some updates!&lt;/p&gt;</content>
    </item>
    
    <item>
      <title>How I Made This Website</title>
      <link>/posts/how-i-made-this-website/</link>
      <pubDate>Sun, 02 Aug 2020 00:00:00 +0000</pubDate>
      
      <guid>/posts/how-i-made-this-website/</guid>
      <description>&lt;p&gt;Hey look I have a fancy new website! ðŸ¦„ðŸ¤–ðŸš€&lt;/p&gt;
&lt;p&gt;What you&amp;rsquo;re reading right now was built and deployed using:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.gatsbyjs.org/&#34;&gt;Gatsby&lt;/a&gt; - A static site generator&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://pages.github.com/&#34;&gt;GitHub Pages&lt;/a&gt; - Host sites from a git repository&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/features/actions&#34;&gt;GitHub Actions&lt;/a&gt; - Automate rebuilding the website whenever changes are pushed to master&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There are plenty of resources out there explaining how to set up a website like this, but I figured it&amp;rsquo;d be nice to gather it into one how-to. I&amp;rsquo;m sure it&amp;rsquo;ll be &lt;em&gt;real&lt;/em&gt; helpful when I forget how this all works in a few months ðŸ˜….&lt;/p&gt;</description>
      <content>&lt;p&gt;Hey look I have a fancy new website! ðŸ¦„ðŸ¤–ðŸš€&lt;/p&gt;
&lt;p&gt;What you&amp;rsquo;re reading right now was built and deployed using:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.gatsbyjs.org/&#34;&gt;Gatsby&lt;/a&gt; - A static site generator&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://pages.github.com/&#34;&gt;GitHub Pages&lt;/a&gt; - Host sites from a git repository&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/features/actions&#34;&gt;GitHub Actions&lt;/a&gt; - Automate rebuilding the website whenever changes are pushed to master&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There are plenty of resources out there explaining how to set up a website like this, but I figured it&amp;rsquo;d be nice to gather it into one how-to. I&amp;rsquo;m sure it&amp;rsquo;ll be &lt;em&gt;real&lt;/em&gt; helpful when I forget how this all works in a few months ðŸ˜….&lt;/p&gt;
&lt;h3 id=&#34;step-1-initialize-a-new-gatsby-site&#34;&gt;Step 1: Initialize a New Gatsby Site&lt;/h3&gt;
&lt;p&gt;It&amp;rsquo;s super easy to get started with &lt;a href=&#34;https://www.gatsbyjs.org/&#34;&gt;Gatsby&lt;/a&gt;. Honestly, the hardest part about it was figuring out a theme or starter to use.&lt;/p&gt;
&lt;p&gt;At first I really liked &lt;a href=&#34;https://github.com/alxshelepenok/gatsby-starter-lumen&#34;&gt;this one&lt;/a&gt;, but the file structure of it started to rub me the wrong way. There&amp;rsquo;s a lot code in there, how do I update it if the starter gets updated? Do I fork it? Am I going to have deal with merge conflicts?&lt;/p&gt;
&lt;p&gt;I switched to &lt;a href=&#34;https://github.com/LekoArts/gatsby-themes/tree/master/themes/gatsby-theme-minimal-blog&#34;&gt;this theme&lt;/a&gt;. It&amp;rsquo;s nice and simple. The only things in my repo are content (if I had any) and site settings. Getting updates from upstream is just a matter of updating the npm package:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dependencies&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;&amp;#34;@lekoarts/gatsby-theme-minimal-blog&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;^2.4.0&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;step-2-create-a-repository-on-github&#34;&gt;Step 2: Create a Repository on GitHub&lt;/h3&gt;
&lt;p&gt;Create a new repository on GitHub and push your new gatsby site to it. If you want GitHub Pages to host your website at &lt;code&gt;&amp;lt;your-username&amp;gt;.github.io&lt;/code&gt;, you &lt;strong&gt;must&lt;/strong&gt; name the repo &lt;code&gt;&amp;lt;your-username&amp;gt;.github.io&lt;/code&gt;. For example, the repo for this website is named &lt;a href=&#34;https://github.com/mattbun/mattbun.github.io&#34;&gt;&lt;code&gt;mattbun.github.io&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&#34;step-3-set-up-github-actions&#34;&gt;Step 3: Set Up GitHub Actions&lt;/h3&gt;
&lt;p&gt;So now the code is on GitHub. But wait, doesn&amp;rsquo;t this repo &lt;em&gt;only&lt;/em&gt; have markdown? How do we compile it and get it deployed?&lt;/p&gt;
&lt;p&gt;That&amp;rsquo;s where GitHub Actions comes in. We&amp;rsquo;ll use it to automatically build the site and push the compiled site to a &lt;code&gt;gh-pages&lt;/code&gt; branch whenever the &lt;code&gt;master&lt;/code&gt; branch is pushed to.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/marketplace/actions/gatsby-publish&#34;&gt;Someone already made an action to do this&lt;/a&gt;, so all you need is this in &lt;code&gt;.github/workflows&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-yaml:title=.github/workflows/publish.yml&#34; data-lang=&#34;yaml:title=.github/workflows/publish.yml&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;name&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;Gatsby Publish&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;on&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;push&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;branches&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      - &lt;span style=&#34;color:#ae81ff&#34;&gt;master&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;jobs&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#f92672&#34;&gt;build&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;runs-on&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;ubuntu-latest&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;steps&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      - &lt;span style=&#34;color:#f92672&#34;&gt;uses&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;actions/checkout@v1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      - &lt;span style=&#34;color:#f92672&#34;&gt;uses&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;enriikke/gatsby-gh-pages-action@v2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;with&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#f92672&#34;&gt;access-token&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;${{ secrets.ACCESS_TOKEN }}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#f92672&#34;&gt;deploy-branch&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;gh-pages&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Before you go and push this change, note that it requires a secret named &lt;code&gt;ACCESS_TOKEN&lt;/code&gt;. It needs that token to push changes to your repo.&lt;/p&gt;
&lt;p&gt;You&amp;rsquo;ll need to generate a personal access token with &lt;code&gt;repo&lt;/code&gt; scope. See &lt;a href=&#34;https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token&#34;&gt;here&lt;/a&gt; for instructions on how to do that. Copy the token, open your repository&amp;rsquo;s settings, go to the &amp;ldquo;Secrets&amp;rdquo; tab, and create a new secret named &lt;code&gt;ACCESS_TOKEN&lt;/code&gt; with the token you copied.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;screenshot_secret.png&#34; alt=&#34;Adding GitHub secret&#34;&gt;&lt;/p&gt;
&lt;p&gt;With the secret in place, go ahead and push those changes. Go to the &amp;ldquo;Actions&amp;rdquo; tab in GitHub and you can watch the build in action. Assuming it completes successfully, you&amp;rsquo;ll find there&amp;rsquo;s a new &lt;code&gt;gh-pages&lt;/code&gt; branch with your compiled website (&lt;a href=&#34;https://github.com/mattbun/mattbun.github.io/tree/gh-pages&#34;&gt;like this&lt;/a&gt;). We&amp;rsquo;re almost there!&lt;/p&gt;
&lt;h3 id=&#34;step-4-enable-github-pages&#34;&gt;Step 4: Enable GitHub Pages&lt;/h3&gt;
&lt;p&gt;Now you just need to &lt;a href=&#34;https://docs.github.com/en/github/working-with-github-pages/configuring-a-publishing-source-for-your-github-pages-site&#34;&gt;enable Github Pages&lt;/a&gt; on this repository. Click the Settings tab and scroll all the way down to the &amp;ldquo;GitHub Pages&amp;rdquo; section. Choose your new &lt;code&gt;gh-pages&lt;/code&gt; branch and hit save!&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;screenshot_pages.png&#34; alt=&#34;Enabling GitHub Pages&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;step-5-try-it-out&#34;&gt;Step 5: Try it Out!&lt;/h3&gt;
&lt;p&gt;That should be it! Open up your website at &lt;code&gt;&amp;lt;username&amp;gt;-github.io&lt;/code&gt; and it should be up and running! ðŸŽ‰ðŸ’ƒ&lt;/p&gt;
&lt;h3 id=&#34;bonus-using-a-custom-domain&#34;&gt;Bonus: Using a Custom Domain&lt;/h3&gt;
&lt;p&gt;In addition to &lt;a href=&#34;https://mattbun.github.io&#34;&gt;mattbun.github.io&lt;/a&gt;, I updated my domain &lt;a href=&#34;https://rathbun.dev&#34;&gt;rathbun.dev&lt;/a&gt; to point to it as well. &lt;a href=&#34;https://docs.github.com/en/github/working-with-github-pages/managing-a-custom-domain-for-your-github-pages-site#configuring-an-apex-domain&#34;&gt;These instructions&lt;/a&gt; show you how to do it. My domain is registered through Google Domains and my DNS settings there look something like this:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;screenshot_dns.png&#34; alt=&#34;Configuring DNS in Google Domains&#34;&gt;&lt;/p&gt;
&lt;p&gt;Be sure to put your domain name in a file named &lt;code&gt;CNAME&lt;/code&gt; in the root directory on your master branch. GitHub will try to add it to your &lt;code&gt;gh-pages&lt;/code&gt; branch but the Gatsby Publish action will overwrite it. If you put it in master, the action &lt;a href=&#34;https://github.com/marketplace/actions/gatsby-publish#cname&#34;&gt;will copy the file over when it deploys&lt;/a&gt;.&lt;/p&gt;</content>
    </item>
    
  </channel>
</rss>
